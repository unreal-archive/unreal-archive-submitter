<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<title>Unreal Archive / Submit Content</title>
	<link rel="stylesheet" href="style.css">

	<link rel="favicon" type="image/png" href="logo-32.png">

	<script type="application/javascript">
		let url = "http://localhost:8081/";

	  document.addEventListener("DOMContentLoaded", function() {

		  document.querySelector('#select-files').addEventListener('click', () => {
			  document.querySelector('#files').click();
		  });

		  document.querySelector('#upload').addEventListener('click', () => {
			  upload();
		  });

		  document.querySelector('#files').addEventListener('change', e => {
			  let fileList = document.querySelector('#files-list');
			  while (fileList.childNodes.length > 0) fileList.removeChild(fileList.childNodes[0]);

			  for (let i = 0; i < e.target.files.length; i++) {
				  let f = e.target.files[i];
				  let name = document.createElement("div");
				  name.innerText = f.name;
				  name.classList.add("name");
				  let size = document.createElement("div");
				  size.innerText = (f.size / 1024 / 1024).toFixed(1) + " mb";
				  size.classList.add("size");
				  let row = document.createElement("div");
				  row.classList.add("file");
				  row.append(name, size);
				  fileList.append(row);
			  }
		  });
	  });

	  function upload() {
		  let data = new FormData();
		  let request = new XMLHttpRequest();

		  let files = document.querySelector('#files').files;
		  console.log("uploading", files);
		  for (let i = 0; i < files.length; i++) {
			  data.append('files', files[i]);
		  }

		  request.addEventListener('load', e => {
			  let logDiv = document.querySelector('#log')
			  while (logDiv.childNodes.length > 0) logDiv.removeChild(logDiv.childNodes[0]);
			  pollJob(e.target.response)
		  });

		  request.upload.addEventListener('progress', e => {
			  document.querySelector('#progress').value = Math.round((e.loaded / e.total) * 100);
		  });

		  request.responseType = 'json';

		  // Send POST request to the server side script
		  request.open('post', url + 'upload');
		  request.send(data);
	  }

	  function pollJob(jobId) {
		  fetch(url + 'job/' + jobId.toString())
			  .then(result => {
				  if (result.ok) {
					  result.json().then(json => {
						  json.forEach(l => pushLog(l));
					  });
					  pollJob(jobId);
				  } else {
					  pushLog(result.statusText);
				  }
			  })
	  }

	  function pushLog(event) {
			let time = document.createElement("div");
			time.classList.add('time');
			let log = document.createElement("div");
			log.classList.add('message');

			let dateStamp;

			if (event instanceof String) {
		  	dateStamp = new Date();
			  log.innerText = event;
			  log.classList.add("error")
		  } else {
		  	dateStamp = new Date(event.time);
			  log.innerText = event.message;
			  if (event.error) log.classList.add("error")
		  }

			time.innerText = '[' + dateStamp.toLocaleTimeString() + ']';

		  let logRow = document.createElement("div");
		  logRow.classList.add('log');
		  logRow.append(time, log);

		  let logDiv = document.querySelector('#log');
		  logDiv.append(logRow);
	  }
	</script>
</head>

<body>

<header>
	<div class="page">
		<div class="heading">
			<a href="https://unrealarchive.org/">
				<img src="logo.png" alt="Unreal Archive"/>
				<span class="a">UNREAL</span><span class="b">ARCHIVE</span>
			</a>
		</div>
	</div>
</header>

<div class="page">
	<article>
		<h1>
			Submit Content
		</h1>
		<p>
			Upload your stuff.
		</p>

		<div class="form">
			<input type="file" id="files" accept=".zip,.rar,.7z,.ace,.gz,.bz2,.tar" multiple style="display:none">
			<button id="select-files">Select Files</button>
			<button id="upload">Upload!</button>
			<progress id="progress" value="0" max="100" style="width: 100%"></progress>
			<div id="files-list"></div>
		</div>

		<div id="log">

		</div>
	</article>
</div>


<footer>
	<div class="page">
		<div style="text-align: right">
			<a href="https://github.com/unreal-archive">
				<img src="ico-github.png" align="absmiddle" alt="github logo"/> Contribute on GitHub
			</a>
		</div>
	</div>
</footer>

</body>
</html>
